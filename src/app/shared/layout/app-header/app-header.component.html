<header class="glass-header">
  <div class="flex flex-col items-center justify-between grow xl:flex-row xl:px-6">
    <div
      class="flex items-center justify-between w-full gap-2 px-3 py-3 border-b border-gray-200 dark:border-gray-800 sm:gap-4 xl:justify-normal xl:border-b-0 xl:px-0 lg:py-3">
      <button
        class="items-center justify-center w-10 h-10 text-gray-500 border-gray-200 rounded-lg z-40 dark:border-gray-800 flex dark:text-gray-400 lg:h-10 lg:w-10 xl:border"
        [ngClass]="{
          'bg-gray-100 dark:bg-white/[0.03]': isMobileOpen()
        }" (click)="handleToggle()" aria-label="Toggle Sidebar">
        @if (isMobileOpen()) {
        <i class="pi pi-times text-xl"></i>
        } @else {
        <i class="pi pi-bars text-xl"></i>
        }
      </button>

      <!-- Active Role Indicator & Change Button -->
      <div
        class="hidden xl:flex items-center gap-3 ml-6 bg-gray-50 dark:bg-white/5 px-3 py-1.5 rounded-full border border-gray-200 dark:border-gray-800 transition-all hover:shadow-sm">
        <div class="flex items-center gap-2">
          <i [class]="selectedRole()?.icon" class="text-brand-500 dark:text-brand-300 text-base"></i>
          <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Rol:</span>
          <span class="text-sm font-bold text-gray-800 dark:text-gray-100">{{ selectedRole()?.name }}</span>
        </div>
        <div class="w-px h-4 bg-gray-200 dark:bg-gray-700 mx-1"></div>
        <button (click)="showRoleModal()"
          class="text-xs font-bold text-brand-600 dark:text-brand-300 hover:text-brand-800 dark:hover:text-brand-200 transition-colors uppercase tracking-widest">
          Cambiar
        </button>
      </div>

      <a routerLink="/" class="xl:hidden mx-auto">
        <img class="dark:hidden w-32" src="/images/bolivia/bolivia-aduana-nacional-01.png" alt="Logo" />
        <img class="hidden dark:block w-32" src="/images/bolivia/bolivia-aduana-nacional-02.png" alt="Logo" />
      </a>

      <button (click)="toggleApplicationMenu()"
        class="flex items-center justify-center w-10 h-10 text-gray-700 rounded-lg z-40 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 xl:hidden">
        <i class="pi pi-ellipsis-h text-xl"></i>
      </button>

    </div>
    <div [ngClass]="isApplicationMenuOpen() ? 'flex' : 'hidden'"
      class="flex-col xl:flex-row items-center justify-between w-full gap-3 px-5 py-4 xl:flex shadow-theme-md xl:justify-end xl:px-0 xl:shadow-none">

      <!-- Compact Mobile Active Role -->
      <div
        class="xl:hidden w-full flex items-center justify-between bg-gray-50 dark:bg-white/5 p-2 rounded-lg border border-gray-100 dark:border-gray-800">
        <div class="flex items-center gap-2">
          <i [class]="selectedRole()?.icon" class="text-brand-500 text-base"></i>
          <span class="text-sm font-bold text-gray-800 dark:text-gray-100">{{ selectedRole()?.name }}</span>
        </div>
        <p-button label="Cambiar" [text]="true" size="small" (click)="showRoleModal()"
          styleClass="font-bold py-0 h-6"></p-button>
      </div>

      <div class="flex items-center justify-between w-full xl:w-auto gap-3">
        <div class="flex items-center gap-3">
          <app-theme-toggle-button />
        </div>
        <div class="xl:hidden">
          <app-user-dropdown />
        </div>
      </div>

      <div class="hidden xl:block">
        <app-user-dropdown />
      </div>
    </div>
  </div>
</header>

<!-- Global Role Selection Modal -->
<p-dialog [(visible)]="isRoleModalVisible" [modal]="true" [header]="'Seleccionar Rol de Usuario'"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }" [style]="{ width: '450px' }" [draggable]="false"
  [resizable]="false" class="role-selection-dialog">

  <div class="flex flex-col gap-4 mt-2">
    <!-- Filter Input -->
    <!-- Filter Input -->
    <p-iconfield iconPosition="left" class="w-full">
      <p-inputicon class="pi pi-search text-gray-500 dark:text-gray-400" />
      <input type="text" pInputText [(ngModel)]="roleSearchQuery" placeholder="Buscar rol por nombre o descripciÃ³n..."
        class="w-full" />
    </p-iconfield>


    <!-- Role List -->
    <div class="flex flex-col gap-2 max-h-[350px] overflow-y-auto custom-scrollbar pr-1">
      @if (isLoadingRoles()) {
        <!-- Skeleton List -->
        @for (i of [1, 2, 3]; track i) {
          <div class="role-item pointer-events-none opacity-60">
            <div class="flex items-center gap-3 w-full">
              <p-skeleton shape="circle" size="2.5rem" />
              <div class="flex flex-col gap-2 grow">
                <p-skeleton width="60%" height="1rem" />
                <p-skeleton width="80%" height="0.75rem" />
              </div>
            </div>
          </div>
        }
      } @else {
        @for (role of filteredRoles(); track role.id) {
        <div (click)="selectRole(role)" (keydown.enter)="selectRole(role)" tabindex="0"
          [class.role-item-active]="selectedRole()?.slug === role.slug"
          class="role-item group focus:ring-2 focus:ring-brand-500/50 outline-none">
          <div class="flex items-center gap-3">
            <div class="role-icon-container" [class.active]="selectedRole()?.slug === role.slug">
              <i [class]="role.icon"></i>
            </div>
            <div class="flex flex-col">
              <span class="role-label">{{ role.name }}</span>
              <span class="role-description text-gray-500 dark:text-gray-400">{{ role.description }}</span>
            </div>
          </div>
          @if (selectedRole()?.slug === role.slug) {
          <i class="pi pi-check-circle text-brand-600 dark:text-brand-400 ml-auto"></i>
          }
        </div>
        } @empty {
        <div class="flex flex-col items-center justify-center py-8 text-gray-400">
          <i class="pi pi-search text-3xl mb-2 opacity-20"></i>
          <p>No se encontraron roles que coincidan</p>
        </div>
        }
      }
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cerrar" icon="pi pi-times" [text]="true" (click)="isRoleModalVisible.set(false)"
      severity="secondary"></p-button>
  </ng-template>
</p-dialog>